<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>NEXUS — Swarm Command</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden;background:#000;font-family:'SF Mono','Fira Code','Cascadia Code',monospace;color:#c0d8e8}

/* ── Canvas ambient layer ── */
canvas#bg{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0}

/* ── HUD chrome ── */
.hud{position:fixed;z-index:10;pointer-events:none}
.hud *{pointer-events:auto}

/* Top bar */
.hud-top{top:0;left:0;right:0;display:flex;justify-content:space-between;align-items:center;padding:8px 16px;background:linear-gradient(180deg,rgba(0,16,32,0.92) 0%,transparent 100%)}
.logo{font-size:11px;font-weight:700;letter-spacing:0.16em;text-transform:uppercase;color:#4dd8e8;display:flex;align-items:center;gap:10px}
.health-orb{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;transition:all 0.6s}
.health-orb.ok{background:rgba(0,232,123,0.1);border:2px solid rgba(0,232,123,0.4);color:#00e87b;box-shadow:0 0 10px rgba(0,232,123,0.08)}
.health-orb.warn{background:rgba(232,168,0,0.1);border:2px solid rgba(232,168,0,0.4);color:#e8a800;box-shadow:0 0 10px rgba(232,168,0,0.08)}
.health-orb.crit{background:rgba(232,48,48,0.1);border:2px solid rgba(232,48,48,0.4);color:#e83030;box-shadow:0 0 10px rgba(232,48,48,0.08)}
.top-stats{display:flex;gap:16px;font-size:10px;align-items:center}
.stat{display:flex;flex-direction:column;align-items:center;gap:1px}
.stat-label{font-size:7px;color:#3a6878;text-transform:uppercase;letter-spacing:0.12em}
.stat-val{font-size:13px;font-weight:700;color:#4dd8e8;font-variant-numeric:tabular-nums}
.stat-val.warn{color:#e8a800}.stat-val.crit{color:#e83030}.stat-val.ok{color:#00e87b}
.clock{font-size:10px;color:#3a6878;font-variant-numeric:tabular-nums}

/* Bottom bar */
.hud-bottom{bottom:0;left:0;right:0;display:flex;justify-content:space-between;align-items:center;padding:6px 16px;background:linear-gradient(0deg,rgba(0,16,32,0.92) 0%,transparent 100%);font-size:9px}
.git-strip{display:flex;gap:12px;align-items:center}
.git-commit{display:flex;align-items:center;gap:4px;opacity:0.7;transition:opacity 0.2s}
.git-commit:hover{opacity:1}
.git-hash{color:#4dd8e8;font-size:8px}.git-msg{color:#6a9aaa;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.git-author{font-size:7px;padding:1px 4px;border-radius:2px;font-weight:600;text-transform:uppercase}
.conn-strip{display:flex;gap:10px}
.conn{display:flex;align-items:center;gap:4px;font-size:8px}
.conn-dot{width:5px;height:5px;border-radius:50%}

/* Left panel: Lanes */
.hud-left{top:44px;left:0;bottom:32px;width:220px;padding:10px;display:flex;flex-direction:column;overflow-y:auto;background:linear-gradient(90deg,rgba(0,12,24,0.6) 0%,transparent 100%)}
.hud-left::-webkit-scrollbar{width:2px}.hud-left::-webkit-scrollbar-thumb{background:#0a2a3a}
.owner-group{margin-bottom:8px}
.owner-title{font-size:7px;text-transform:uppercase;letter-spacing:0.16em;margin-bottom:4px;padding-bottom:3px;border-bottom:1px solid rgba(255,255,255,0.04)}
.lane{display:flex;align-items:center;gap:6px;padding:5px 6px;border-radius:3px;font-size:9px;cursor:pointer;transition:all 0.15s;border-left:2px solid transparent;position:relative}
.lane:hover{background:rgba(77,216,232,0.06)}
.lane.selected{border-left-color:#4dd8e8;background:rgba(77,216,232,0.04)}
.lane .l-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.lane .l-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#7ab0c0;font-size:8px}
.lane .l-stat{font-size:7px;color:#3a6878;font-variant-numeric:tabular-nums}
.lane .l-hb{position:absolute;right:4px;top:2px;font-size:6px;color:#3a5868}
.progress-micro{height:2px;background:rgba(255,255,255,0.03);border-radius:1px;margin-top:2px;overflow:hidden}
.progress-micro-fill{height:100%;border-radius:1px;transition:width 0.4s}

/* Right panel: Events + Alerts */
.hud-right{top:44px;right:0;bottom:32px;width:280px;padding:10px;display:flex;flex-direction:column;background:linear-gradient(270deg,rgba(0,12,24,0.6) 0%,transparent 100%)}
.panel-title{font-size:7px;color:#3a6878;text-transform:uppercase;letter-spacing:0.16em;margin-bottom:4px;padding-bottom:3px;border-bottom:1px solid rgba(255,255,255,0.04);display:flex;justify-content:space-between}
.alert-zone{margin-bottom:8px}
.alert{padding:5px 8px;margin-bottom:2px;border-radius:3px;font-size:9px;border-left:2px solid;animation:alertIn 0.3s ease-out}
.alert.high{border-color:#e83030;background:rgba(232,48,48,0.06);color:#d04040}
.alert.medium{border-color:#e8a800;background:rgba(232,168,0,0.04);color:#c09030}
.alert .alert-type{font-size:7px;text-transform:uppercase;letter-spacing:0.06em;font-weight:700;opacity:0.7}
@keyframes alertIn{from{opacity:0;transform:translateX(12px)}to{opacity:1;transform:translateX(0)}}
.feed{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:1px}
.feed::-webkit-scrollbar{width:2px}.feed::-webkit-scrollbar-thumb{background:#0a2a3a}
.evt{padding:3px 6px;font-size:8px;border-left:2px solid #1a3040;animation:fadeSlide 0.25s ease-out}
.evt .evt-time{font-size:6px;color:#2a5060}.evt .evt-body{margin-top:1px;color:#6a9aaa}
.evt .evt-lane{font-size:6px;color:#3a6878}
@keyframes fadeSlide{from{opacity:0;transform:translateX(10px)}to{opacity:1;transform:translateX(0)}}

/* Center: detail overlay */
#detail-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,8,16,0.75);z-index:100;display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px)}
#detail-overlay.open{display:flex}
#detail-panel{background:rgba(0,18,32,0.97);border:1px solid #0a2a4a;border-radius:8px;padding:20px;max-width:520px;width:92%;max-height:82vh;overflow-y:auto;position:relative}
#detail-panel .close-btn{position:absolute;top:8px;right:10px;background:none;border:none;color:#3a6878;font-size:16px;cursor:pointer}
#detail-panel h3{font-size:11px;color:#4dd8e8;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:10px}
.d-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:12px}
.d-card{background:rgba(20,35,50,0.5);border-radius:4px;padding:8px;text-align:center}
.d-card-label{font-size:7px;color:#3a6878;text-transform:uppercase;letter-spacing:0.1em}
.d-card-val{font-size:14px;font-weight:700;margin-top:2px}
.d-section{font-size:7px;color:#3a6878;text-transform:uppercase;letter-spacing:0.14em;margin:12px 0 6px;padding-top:8px;border-top:1px solid #0a1a2a}
.d-task{padding:5px 8px;margin:2px 0;font-size:9px;border-left:2px solid #1a3040;background:rgba(10,20,30,0.4);border-radius:2px}
.d-task-status{font-size:7px;text-transform:uppercase;font-weight:700;letter-spacing:0.06em}
.d-task-summary{color:#6a9aaa;margin-top:1px}

/* Loading state */
.loading{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:200;color:#3a6878;font-size:11px;text-align:center}
.loading .spinner{width:24px;height:24px;border:2px solid #0a2a3a;border-top-color:#4dd8e8;border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 8px}
@keyframes spin{to{transform:rotate(360deg)}}

/* Refresh indicator */
.refresh-dot{width:4px;height:4px;border-radius:50%;background:#4dd8e8;opacity:0;transition:opacity 0.3s;margin-left:6px}
.refresh-dot.active{opacity:1;animation:pulse 0.5s ease-out}
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(2)}100%{transform:scale(1)}}

/* Responsive */
@media(max-width:800px){
  .hud-left{width:160px}.hud-right{width:200px}
  .top-stats{gap:8px}.stat-val{font-size:11px}
}
@media(max-width:600px){
  .hud-left,.hud-right{display:none}
  .hud-top{padding:6px 10px}
}
</style>
</head>
<body>

<canvas id="bg"></canvas>

<!-- Loading state -->
<div class="loading" id="loading">
  <div class="spinner"></div>
  <div>Connecting to swarm...</div>
</div>

<!-- Top HUD -->
<div class="hud hud-top" id="top-bar" style="display:none">
  <div class="logo">
    <div class="health-orb ok" id="health-orb">0</div>
    <span>NEXUS — Swarm Command</span>
    <div class="refresh-dot" id="refresh-dot"></div>
  </div>
  <div class="top-stats" id="top-stats"></div>
  <div class="clock" id="clock"></div>
</div>

<!-- Left: Lanes -->
<div class="hud hud-left" id="lane-panel" style="display:none">
  <div class="panel-title"><span>Lanes</span><span id="lane-count"></span></div>
  <div id="lane-list"></div>
</div>

<!-- Right: Events + Alerts -->
<div class="hud hud-right" id="event-panel" style="display:none">
  <div class="alert-zone" id="alert-zone"></div>
  <div class="panel-title"><span>Event Stream</span><span id="evt-count"></span></div>
  <div class="feed" id="event-feed"></div>
</div>

<!-- Bottom: Git + Connectivity -->
<div class="hud hud-bottom" id="bottom-bar" style="display:none">
  <div class="git-strip" id="git-strip"></div>
  <div class="conn-strip" id="conn-strip"></div>
</div>

<!-- Detail Overlay -->
<div id="detail-overlay" onclick="if(event.target===this)closeDetail()">
  <div id="detail-panel">
    <button class="close-btn" onclick="closeDetail()">&times;</button>
    <div id="detail-body"></div>
  </div>
</div>

<script>
// ═══════════════════════════════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════════════════════════════
let DATA = null;
let selectedLaneId = null;
let pollTimer = null;
const POLL_INTERVAL = 5000;
const OWNER_COLORS = {codex:'#00c8ff',gemini:'#ff8800',claude:'#a855f7',unknown:'#5a7a8a'};
const STATUS_COLORS = {done:'#00e87b',in_progress:'#4dd8e8',blocked:'#e83030',pending:'#e8a800',idle:'#3a5868'};
const EVT_BORDER = {
  task_selected:'#4dd8e8',task_done:'#00e87b',task_blocked:'#e83030',
  routing_decision:'#8a60d8',agent_error:'#e8a800',prompt:'#2a5a7a',
  conversation_start:'#4dd8e8',conversation_end:'#00e87b',
};

// ═══════════════════════════════════════════════════════════════════
// CANVAS — Ambient awareness layer
// ═══════════════════════════════════════════════════════════════════
const canvas = document.getElementById('bg');
const ctx = canvas.getContext('2d');
const dpr = window.devicePixelRatio || 1;
let W, H, cx, cy;

function resize() {
  W = window.innerWidth; H = window.innerHeight;
  canvas.width = W * dpr; canvas.height = H * dpr;
  canvas.style.width = W + 'px'; canvas.style.height = H + 'px';
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  cx = W / 2; cy = H / 2;
}
resize();
window.addEventListener('resize', resize);

// Particles
class Particle {
  constructor(type) {
    const angle = Math.random() * Math.PI * 2;
    const dist = 60 + Math.random() * Math.min(W, H) * 0.35;
    this.x = cx + Math.cos(angle) * dist;
    this.y = cy + Math.sin(angle) * dist;
    this.vx = (Math.random() - 0.5) * 0.25;
    this.vy = (Math.random() - 0.5) * 0.25;
    this.life = 1;
    this.decay = 0.001 + Math.random() * 0.004;
    this.type = type;
    this.size = type === 'error' ? 2.5 : type === 'event' ? 1.8 : 1.2;
    this.color = type === 'error' ? [232,48,48] : type === 'event' ? [77,216,232] : [0,232,123];
  }
  update() {
    this.x += this.vx; this.y += this.vy; this.life -= this.decay;
    this.vx += (cx - this.x) * 0.00002;
    this.vy += (cy - this.y) * 0.00002;
  }
  draw(c) {
    if (this.life <= 0) return;
    const [r,g,b] = this.color;
    c.beginPath();
    c.arc(this.x, this.y, this.size * this.life, 0, Math.PI * 2);
    c.fillStyle = `rgba(${r},${g},${b},${this.life * 0.5})`;
    c.fill();
    c.beginPath();
    c.arc(this.x, this.y, this.size * 2.5 * this.life, 0, Math.PI * 2);
    c.fillStyle = `rgba(${r},${g},${b},${this.life * 0.06})`;
    c.fill();
  }
}

let particles = [];
let commitPulses = [];
let radarAngle = 0;
let frame = 0;
let ambientHue = [0, 30, 60]; // RGB tint for ambient health

function spawnParticle() {
  if (!DATA) return;
  const alerts = DATA.alerts || [];
  const hasErrors = alerts.some(a => a.severity === 'high');
  const types = hasErrors
    ? ['task','event','error','error','event']
    : ['task','task','task','event','event'];
  particles.push(new Particle(types[Math.floor(Math.random() * types.length)]));
}

function triggerCommitPulse() {
  commitPulses.push({ r: 0, alpha: 0.25 });
}

function drawGrid() {
  ctx.strokeStyle = 'rgba(77,216,232,0.012)';
  ctx.lineWidth = 1;
  const step = 50;
  for (let x = 0; x < W; x += step) {
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke();
  }
  for (let y = 0; y < H; y += step) {
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
  }
  // Scanlines
  ctx.fillStyle = 'rgba(0,0,0,0.025)';
  for (let y = 0; y < H; y += 3) ctx.fillRect(0, y, W, 1);
}

function drawRadar() {
  const r = Math.min(W, H) * 0.22;
  // Rings
  for (const rf of [1, 0.65, 0.35]) {
    ctx.beginPath();
    ctx.arc(cx, cy, r * rf, 0, Math.PI * 2);
    ctx.strokeStyle = 'rgba(77,216,232,0.04)';
    ctx.lineWidth = 1;
    ctx.stroke();
  }
  // Cross
  ctx.strokeStyle = 'rgba(77,216,232,0.025)';
  ctx.beginPath();
  ctx.moveTo(cx - r, cy); ctx.lineTo(cx + r, cy);
  ctx.moveTo(cx, cy - r); ctx.lineTo(cx, cy + r);
  ctx.stroke();

  // Sweep
  radarAngle += 0.006;
  ctx.beginPath();
  ctx.moveTo(cx, cy);
  ctx.arc(cx, cy, r, radarAngle - 0.4, radarAngle);
  ctx.closePath();
  const g = ctx.createRadialGradient(cx, cy, 0, cx, cy, r);
  g.addColorStop(0, 'rgba(77,216,232,0.0)');
  g.addColorStop(0.5, 'rgba(77,216,232,0.03)');
  g.addColorStop(1, 'rgba(77,216,232,0.08)');
  ctx.fillStyle = g;
  ctx.fill();

  // Sweep line
  ctx.beginPath();
  ctx.moveTo(cx, cy);
  ctx.lineTo(cx + Math.cos(radarAngle) * r, cy + Math.sin(radarAngle) * r);
  ctx.strokeStyle = 'rgba(77,216,232,0.18)';
  ctx.lineWidth = 1;
  ctx.stroke();

  // Lane blips
  if (DATA && DATA.lanes) {
    const lanes = DATA.lanes;
    lanes.forEach((lane, i) => {
      const a = (i / Math.max(lanes.length, 1)) * Math.PI * 2 - Math.PI / 2;
      const taskPct = lane.task_counts ?
        ((lane.task_counts.done || 0) / Math.max(Object.values(lane.task_counts).reduce((s,v)=>s+v,0), 1)) : 0.5;
      const d = r * 0.3 + taskPct * r * 0.5;
      const bx = cx + Math.cos(a) * Math.min(d, r * 0.88);
      const by = cy + Math.sin(a) * Math.min(d, r * 0.88);
      const c = STATUS_COLORS[lane.status] || '#3a5868';

      // Proximity glow from sweep
      const angleDiff = Math.abs(((radarAngle % (Math.PI*2)) + Math.PI*2) % (Math.PI*2) - ((a % (Math.PI*2)) + Math.PI*2) % (Math.PI*2));
      const intensity = angleDiff < 0.5 ? (0.5 - angleDiff) / 0.5 : 0;
      const alpha = 0.25 + intensity * 0.75;

      ctx.beginPath();
      ctx.arc(bx, by, 2.5 + intensity * 3, 0, Math.PI * 2);
      ctx.fillStyle = c.replace(')', `,${alpha})`).replace('rgb', 'rgba').replace('#', '');
      // Convert hex to rgba
      const hr = parseInt(c.slice(1,3),16), hg = parseInt(c.slice(3,5),16), hb = parseInt(c.slice(5,7),16);
      ctx.fillStyle = `rgba(${hr},${hg},${hb},${alpha.toFixed(2)})`;
      ctx.fill();

      if (lane.status === 'in_progress') {
        ctx.beginPath();
        ctx.arc(bx, by, 7 + Math.sin(Date.now()/600) * 2, 0, Math.PI * 2);
        ctx.strokeStyle = `rgba(${hr},${hg},${hb},0.15)`;
        ctx.lineWidth = 1;
        ctx.stroke();
      }
    });
  }
}

function drawBudgetArc() {
  if (!DATA || !DATA.summary) return;
  const r = Math.min(W, H) * 0.22 + 16;
  const startA = -Math.PI * 0.75;
  const endA = -Math.PI * 0.25;
  // Use health data budget if available
  const health = DATA.health?.health || {};
  const cap = health.budget_daily_cap || 100;
  const spent = DATA.summary.total_cost_usd || 0;
  const pct = Math.min(spent / cap, 1);
  const spentAngle = startA + pct * (endA - startA);

  ctx.beginPath();
  ctx.arc(cx, cy, r, startA, endA);
  ctx.strokeStyle = 'rgba(77,216,232,0.04)';
  ctx.lineWidth = 2.5;
  ctx.stroke();

  ctx.beginPath();
  ctx.arc(cx, cy, r, startA, spentAngle);
  ctx.strokeStyle = pct > 0.8 ? 'rgba(232,48,48,0.4)' : pct > 0.5 ? 'rgba(232,168,0,0.4)' : 'rgba(0,232,123,0.35)';
  ctx.lineWidth = 2.5;
  ctx.stroke();

  ctx.font = '7px monospace';
  ctx.fillStyle = 'rgba(77,216,232,0.25)';
  ctx.textAlign = 'center';
  ctx.fillText(`BUDGET $${spent.toFixed(2)} / $${cap}`, cx, cy - r - 6);
}

function drawCommitPulses() {
  commitPulses = commitPulses.filter(p => p.alpha > 0.005);
  commitPulses.forEach(p => {
    p.r += 1.2;
    p.alpha *= 0.988;
    ctx.beginPath();
    ctx.arc(cx, cy, p.r, 0, Math.PI * 2);
    ctx.strokeStyle = `rgba(0,232,123,${p.alpha})`;
    ctx.lineWidth = 1;
    ctx.stroke();
  });
}

function render() {
  ctx.clearRect(0, 0, W, H);

  // Ambient gradient (shifts with health)
  const [ar, ag, ab] = ambientHue;
  const bg = ctx.createRadialGradient(cx, cy, 0, cx, cy, Math.max(W, H) * 0.7);
  bg.addColorStop(0, `rgb(${2+ar},${8+ag},${16+ab})`);
  bg.addColorStop(1, '#000306');
  ctx.fillStyle = bg;
  ctx.fillRect(0, 0, W, H);

  drawGrid();
  drawRadar();
  drawBudgetArc();
  drawCommitPulses();

  if (frame % 10 === 0) spawnParticle();
  particles = particles.filter(p => p.life > 0);
  particles.forEach(p => { p.update(); p.draw(ctx); });
  if (frame % 400 === 0 && DATA) triggerCommitPulse();

  frame++;
  requestAnimationFrame(render);
}
render();

// ═══════════════════════════════════════════════════════════════════
// DATA FETCHING
// ═══════════════════════════════════════════════════════════════════
async function fetchSnapshot() {
  try {
    const resp = await fetch('/api/v2/snapshot');
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    DATA = await resp.json();
    updateDOM();
    updateAmbient();
    return true;
  } catch (e) {
    console.warn('Fetch failed:', e);
    return false;
  }
}

function updateAmbient() {
  if (!DATA) return;
  const alerts = DATA.alerts || [];
  const hasCrit = alerts.some(a => a.severity === 'high');
  const hasWarn = alerts.length > 0;
  if (hasCrit) {
    ambientHue = [12, 2, 4]; // red tint
  } else if (hasWarn) {
    ambientHue = [8, 6, 0]; // amber tint
  } else {
    ambientHue = [0, 4, 10]; // blue/healthy tint
  }
}

function startPolling() {
  fetchSnapshot().then(ok => {
    document.getElementById('loading').style.display = 'none';
    ['top-bar','lane-panel','event-panel','bottom-bar'].forEach(id => {
      document.getElementById(id).style.display = '';
    });
  });
  pollTimer = setInterval(async () => {
    const dot = document.getElementById('refresh-dot');
    dot.classList.add('active');
    await fetchSnapshot();
    setTimeout(() => dot.classList.remove('active'), 400);
  }, POLL_INTERVAL);
}

// ═══════════════════════════════════════════════════════════════════
// DOM UPDATES
// ═══════════════════════════════════════════════════════════════════
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function updateDOM() {
  if (!DATA) return;
  updateTopBar();
  updateLanes();
  updateEvents();
  updateAlerts();
  updateBottomBar();
}

function updateTopBar() {
  const s = DATA.summary || {};
  const alerts = DATA.alerts || [];
  const hasCrit = alerts.some(a => a.severity === 'high');
  const orb = document.getElementById('health-orb');
  orb.textContent = alerts.length || '\u2713';
  orb.className = 'health-orb ' + (hasCrit ? 'crit' : alerts.length > 0 ? 'warn' : 'ok');

  const sc = s.status_counts || {};
  const stats = [
    { label: 'Lanes', val: s.lanes_total || 0, cls: '' },
    { label: 'Done', val: sc.done || 0, cls: 'ok' },
    { label: 'Active', val: sc.in_progress || 0, cls: '' },
    { label: 'Blocked', val: sc.blocked || 0, cls: (sc.blocked || 0) > 0 ? 'crit' : '' },
    { label: 'Cost', val: '$' + (s.total_cost_usd || 0).toFixed(2), cls: '' },
    { label: 'Tokens', val: formatTokens(s.total_tokens || 0), cls: '' },
    { label: 'Responses', val: s.total_responses || 0, cls: '' },
    { label: 'Alerts', val: s.alerts_count || 0, cls: (s.alerts_count || 0) > 0 ? 'warn' : '' },
  ];

  const statsEl = document.getElementById('top-stats');
  statsEl.innerHTML = stats.map(st =>
    `<div class="stat"><span class="stat-label">${st.label}</span><span class="stat-val ${st.cls}">${st.val}</span></div>`
  ).join('');
}

function formatTokens(n) {
  if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
  if (n >= 1e3) return (n / 1e3).toFixed(0) + 'K';
  return String(n);
}

function updateLanes() {
  const lanes = DATA.lanes || [];
  document.getElementById('lane-count').textContent = lanes.length;

  // Group by owner
  const grouped = {};
  lanes.forEach(l => {
    const o = l.owner || 'unknown';
    if (!grouped[o]) grouped[o] = [];
    grouped[o].push(l);
  });

  const list = document.getElementById('lane-list');
  list.innerHTML = '';

  Object.entries(grouped).sort().forEach(([owner, ownerLanes]) => {
    const color = OWNER_COLORS[owner] || OWNER_COLORS.unknown;
    const group = document.createElement('div');
    group.className = 'owner-group';
    group.innerHTML = `<div class="owner-title" style="color:${color}">${esc(owner.toUpperCase())} \u2014 ${ownerLanes.length}</div>`;

    ownerLanes.forEach(lane => {
      const tc = lane.task_counts || {};
      const total = (tc.done||0) + (tc.in_progress||0) + (tc.pending||0) + (tc.blocked||0);
      const done = tc.done || 0;
      const pct = total > 0 ? (done / total * 100) : 0;
      const sc = STATUS_COLORS[lane.status] || '#3a5868';
      const hbAge = lane.heartbeat?.age_sec;
      const hbStr = hbAge != null && hbAge >= 0 ? hbAge + 's' : '';

      const div = document.createElement('div');
      div.className = 'lane' + (selectedLaneId === lane.lane_id ? ' selected' : '');
      div.innerHTML = `
        <span class="l-dot" style="background:${sc};box-shadow:0 0 4px ${sc}"></span>
        <span class="l-name">${esc(lane.lane_id)}</span>
        <span class="l-stat">${done}/${total}</span>
        ${hbStr ? `<span class="l-hb">${esc(hbStr)}</span>` : ''}
        <div class="progress-micro" style="width:100%"><div class="progress-micro-fill" style="width:${pct}%;background:${sc}"></div></div>
      `;
      div.onclick = () => showLaneDetail(lane);
      group.appendChild(div);
    });

    list.appendChild(group);
  });
}

function updateAlerts() {
  const alerts = DATA.alerts || [];
  const zone = document.getElementById('alert-zone');
  if (alerts.length === 0) {
    zone.innerHTML = '';
    return;
  }
  zone.innerHTML = `<div class="panel-title"><span>Alerts</span><span style="color:#e83030">${alerts.length}</span></div>` +
    alerts.slice(0, 8).map(a =>
      `<div class="alert ${esc(a.severity || 'medium')}" onclick="alertClick('${esc(a.lane_id || '')}')">
        <div class="alert-type">${esc(a.type || '')}</div>
        <div>${esc(a.message || '')}</div>
      </div>`
    ).join('');
}

function alertClick(laneId) {
  if (!laneId || !DATA) return;
  const lane = (DATA.lanes || []).find(l => l.lane_id === laneId);
  if (lane) showLaneDetail(lane);
}

function updateEvents() {
  const events = DATA.events || [];
  document.getElementById('evt-count').textContent = events.length;

  const feed = document.getElementById('event-feed');
  feed.innerHTML = events.slice(0, 60).map(evt => {
    const type = evt.type || evt.event_type || '';
    const borderColor = EVT_BORDER[type] || '#1a3040';
    const ts = evt.timestamp ? evt.timestamp.slice(11, 19) : '';
    const laneId = evt.lane_id || '';
    const body = evt.message || evt.summary || evt.body || type;
    return `<div class="evt" style="border-left-color:${borderColor}">
      <div class="evt-time">${esc(ts)} <span class="evt-lane">${esc(laneId)}</span></div>
      <div class="evt-body">${esc(String(body).slice(0, 120))}</div>
    </div>`;
  }).join('');
}

function updateBottomBar() {
  // Git
  const git = DATA.git || {};
  const commits = git.recent_commits || [];
  const gitStrip = document.getElementById('git-strip');
  const branch = git.current_branch || '';
  gitStrip.innerHTML = `<span style="color:#3a6878;font-size:8px">GIT</span>` +
    (branch ? `<span style="color:#4dd8e8;font-size:8px">${esc(branch)}</span>` : '') +
    `<span style="color:#3a6878;font-size:7px">${git.branch_count || 0} branches</span>` +
    commits.slice(0, 4).map(c => {
      const authorColor = OWNER_COLORS[c.author] || '#5a7a8a';
      return `<div class="git-commit">
        <span class="git-hash">${esc((c.short_hash || c.hash || '').slice(0,7))}</span>
        <span class="git-msg">${esc((c.message || '').slice(0,40))}</span>
        <span class="git-author" style="background:${authorColor}20;color:${authorColor}">${esc(c.author || '')}</span>
      </div>`;
    }).join('');

  // Connectivity
  const conn = DATA.connectivity || {};
  const connStrip = document.getElementById('conn-strip');
  if (conn.endpoints && Array.isArray(conn.endpoints)) {
    connStrip.innerHTML = conn.endpoints.slice(0, 5).map(ep => {
      const ok = ep.ok || ep.status === 'ok';
      return `<div class="conn">
        <div class="conn-dot" style="background:${ok?'#00e87b':'#e83030'};box-shadow:0 0 3px ${ok?'#00e87b':'#e83030'}"></div>
        <span style="color:${ok?'#5a8a9a':'#c06060'}">${esc(ep.id || ep.name || '')}</span>
      </div>`;
    }).join('');
  } else {
    connStrip.innerHTML = '<span style="color:#3a5868">No connectivity data</span>';
  }
}

// ═══════════════════════════════════════════════════════════════════
// DETAIL PANEL
// ═══════════════════════════════════════════════════════════════════
function closeDetail() {
  document.getElementById('detail-overlay').classList.remove('open');
  selectedLaneId = null;
  updateLanes();
}

function showLaneDetail(lane) {
  selectedLaneId = lane.lane_id;
  updateLanes();
  const overlay = document.getElementById('detail-overlay');
  const body = document.getElementById('detail-body');
  const ownerColor = OWNER_COLORS[lane.owner] || OWNER_COLORS.unknown;
  const statusColor = STATUS_COLORS[lane.status] || '#3a5868';

  const tc = lane.task_counts || {};
  const total = (tc.done||0) + (tc.in_progress||0) + (tc.pending||0) + (tc.blocked||0);
  const hb = lane.heartbeat || {};
  const metrics = lane.metrics || {};
  const config = lane.config || {};

  let h = `<h3 style="color:${ownerColor}">\u2B21 ${esc(lane.lane_id)}</h3>`;

  // Summary cards
  h += `<div class="d-grid">
    <div class="d-card"><div class="d-card-label">Status</div><div class="d-card-val" style="color:${statusColor}">${esc((lane.status||'').toUpperCase().replace('_',' '))}</div></div>
    <div class="d-card"><div class="d-card-label">Progress</div><div class="d-card-val" style="color:${ownerColor}">${tc.done||0} / ${total}</div></div>
    <div class="d-card"><div class="d-card-label">Cost</div><div class="d-card-val">$${(metrics.cost_usd_total||0).toFixed(2)}</div></div>
    <div class="d-card"><div class="d-card-label">Heartbeat</div><div class="d-card-val" style="color:${(hb.age_sec||0)>120?'#e8a800':'#c0d8e8'}">${hb.age_sec != null && hb.age_sec >= 0 ? hb.age_sec+'s' : 'N/A'}</div></div>
    <div class="d-card"><div class="d-card-label">Owner</div><div class="d-card-val" style="color:${ownerColor}">${esc((lane.owner||'').toUpperCase())}</div></div>
    <div class="d-card"><div class="d-card-label">Tokens</div><div class="d-card-val">${formatTokens(metrics.tokens_total||0)}</div></div>
    <div class="d-card"><div class="d-card-label">Pass Rate</div><div class="d-card-val" style="color:${(metrics.first_time_pass_rate||0)<0.5?'#e8a800':'#00e87b'}">${((metrics.first_time_pass_rate||0)*100).toFixed(0)}%</div></div>
    <div class="d-card"><div class="d-card-label">Responses</div><div class="d-card-val">${metrics.responses_total||0}</div></div>
  </div>`;

  // Heartbeat detail
  if (hb.phase || hb.cycle) {
    h += `<div class="d-section">Heartbeat</div>`;
    h += `<div style="font-size:9px;color:#6a9aaa;padding:6px;background:rgba(10,20,30,0.4);border-radius:3px">`;
    if (hb.phase) h += `Phase: <span style="color:#4dd8e8">${esc(hb.phase)}</span> &middot; `;
    if (hb.cycle) h += `Cycle: <span style="color:#4dd8e8">${hb.cycle}</span> &middot; `;
    if (hb.message) h += `${esc(hb.message)}`;
    h += `</div>`;
  }

  // Tasks
  const tasks = lane.tasks || [];
  if (tasks.length > 0) {
    h += `<div class="d-section">Tasks (${tasks.length})</div>`;
    tasks.forEach(t => {
      const tsc = STATUS_COLORS[t.status] || '#3a5868';
      h += `<div class="d-task" style="border-left-color:${tsc}">
        <div class="d-task-status" style="color:${tsc}">${esc((t.status||'').toUpperCase())} \u2014 ${esc(t.task_id)}</div>
        ${t.last_summary ? `<div class="d-task-summary">${esc(t.last_summary)}</div>` : ''}
        ${t.last_error ? `<div style="color:#c06060;font-size:8px;margin-top:2px">${esc(t.last_error)}</div>` : ''}
        <div style="font-size:7px;color:#3a5868;margin-top:2px">Attempts: ${t.attempts||0} &middot; Deadlock recoveries: ${t.deadlock_recoveries||0}</div>
      </div>`;
    });
  }

  // Config
  if (config.execution_profile || config.started_at) {
    h += `<div class="d-section">Configuration</div>`;
    h += `<div style="font-size:9px;color:#5a8a9a;display:grid;grid-template-columns:1fr 1fr;gap:4px">`;
    if (config.execution_profile) h += `<div>Profile: <span style="color:#4dd8e8">${esc(config.execution_profile)}</span></div>`;
    if (config.started_at) h += `<div>Started: <span style="color:#4dd8e8">${esc(config.started_at)}</span></div>`;
    h += `<div>Continuous: <span style="color:#4dd8e8">${config.continuous ? 'yes' : 'no'}</span></div>`;
    if (config.max_cycles) h += `<div>Max cycles: <span style="color:#4dd8e8">${config.max_cycles}</span></div>`;
    h += `</div>`;
  }

  // Related alerts
  const relAlerts = (DATA.alerts || []).filter(a => a.lane_id === lane.lane_id);
  if (relAlerts.length > 0) {
    h += `<div class="d-section">Active Alerts</div>`;
    relAlerts.forEach(a => {
      const ac = a.severity === 'high' ? '#e83030' : '#e8a800';
      h += `<div style="padding:5px 8px;margin:2px 0;border-radius:3px;background:${a.severity==='high'?'rgba(232,48,48,0.06)':'rgba(232,168,0,0.04)'};border-left:2px solid ${ac};font-size:9px;color:${ac}">${esc(a.message||'')}</div>`;
    });
  }

  // Related events
  const relEvents = (DATA.events || []).filter(e => e.lane_id === lane.lane_id).slice(0, 10);
  if (relEvents.length > 0) {
    h += `<div class="d-section">Recent Events</div>`;
    relEvents.forEach(e => {
      const ts = e.timestamp ? e.timestamp.slice(11, 19) : '';
      h += `<div style="font-size:8px;padding:3px 0;border-bottom:1px solid #0a1a2a">
        <span style="color:#2a5060">${esc(ts)}</span>
        <span style="color:#6a9aaa">${esc((e.message || e.summary || e.type || '').slice(0,100))}</span>
      </div>`;
    });
  }

  // Related git commits
  const owner = lane.owner;
  const relCommits = (DATA.git?.recent_commits || []).filter(c => c.author === owner).slice(0, 4);
  if (relCommits.length > 0) {
    h += `<div class="d-section">Recent Commits (${esc(owner)})</div>`;
    relCommits.forEach(c => {
      h += `<div style="font-size:8px;padding:3px 0;border-bottom:1px solid #0a1a2a">
        <span style="color:#4dd8e8">${esc((c.short_hash || c.hash || '').slice(0,7))}</span>
        <span style="color:#7ab0c0">${esc((c.message||'').slice(0,60))}</span>
        <span style="color:#2a5060">${esc(c.relative_time||'')}</span>
      </div>`;
    });
  }

  body.innerHTML = h;
  overlay.classList.add('open');
}

// ═══════════════════════════════════════════════════════════════════
// CLOCK + KEYBOARD
// ═══════════════════════════════════════════════════════════════════
setInterval(() => {
  const el = document.getElementById('clock');
  if (el) el.textContent = new Date().toISOString().slice(11, 19) + 'Z';
}, 1000);

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeDetail();
  if (e.key === 'r' && !e.ctrlKey && !e.metaKey && document.activeElement === document.body) {
    fetchSnapshot();
  }
});

// ═══════════════════════════════════════════════════════════════════
// BOOT
// ═══════════════════════════════════════════════════════════════════
startPolling();
</script>
</body>
</html>
